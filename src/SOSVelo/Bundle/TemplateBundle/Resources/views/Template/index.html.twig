{# SOSVelo/Bundle/TemplateBundle/Resources/views/Template/index.html.twig #}

{% extends '@SOSVeloTemplate/layout.html.twig' %}

{% block title %}SOSVelo !{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>

    {% stylesheets
    '@SOSVeloTemplateBundle/Resources/public/css/owl.carousel.min.css'
    '@SOSVeloTemplateBundle/Resources/public/css/owl.theme.default.css' %}
    <link rel="stylesheet" href="{{ asset_url }}"/>
    {% endstylesheets %}

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet"
          href="//rawgithub.com/domoritz/leaflet-locatecontrol/gh-pages/dist/L.Control.Locate.min.css"/>
    <!--[if lt IE 9]>
    <link rel="stylesheet"
          href="//rawgithub.com/domoritz/leaflet-locatecontrol/gh-pages/dist/L.Control.Locate.ie.min.css"/>
    <![endif]-->

    <style>
        /*demo item for carousel*/
        #owl-slider .item {
            background: #42bdc2;
            padding: 30px 0px;
            margin: 5px;
            color: #FFF;
            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
            text-align: center;
        }

        #tabs-1, #tabs-1 ul, #tabs-1 li {
            list-style: none;
            display: inline;
        }

        #tabs-1 ul {
            padding: 0;
            margin: 0 0 0 18px;
        }

        #tabs-1 {
            padding: 4px;
            margin: 0px;
        }

        #tabs-1 > li {
            margin: 4px 0;
        }

        #tabs-1 > li li {
            margin: 2px 0;
        }

        #tabs-1 a {
            color: #333;
            outline: none;
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 255);
            border-radius: 6px
        }

        #tabs-1 li > a > span {
            float: right;
            font-size: 19px;
            font-weight: bolder;
        }

        #tabs-1 li > a:hover > span {
            color: #fff;
        }

        #tabs-1 li > a > span:after {
            content: '\25be';
        }
        #tabs-1 li.open > a > span:after {
            content: '\25b4';
        }

        #tabs-1 a:hover, #tabs-1 li.active > a {
            background-color: #5D5D5D;
            color: #f5f5f5;
        }

        #tabs-1 > li.active > a  {
            background-color: #4D90FE;
        }

        #tabs-1 li a {
            color: #ffffff;
            font-size: 20px;
            line-height: 18px;
            padding: 2px 10px;
        }

        #tabs-1 > li > a {
            font-size: 14px;
            line-height: 20px;
            padding: 4px 10px;
        }
    </style>
{% endblock %}


{% block noscriptstylesheets %}
    {{ parent() }}
{% endblock %}

{% block body %}
    {% block menu %}
        {{ parent() }}
    {% endblock %}
    <!-- Banner -->
    <section id="banner" style="padding-top: 10px;">
        <h2>SOSVélo</h2>

        <p>Vous trouvez ici toutes les informations de points SOSVélo</p>

        <form>
            <div class="row uniform 50%">
                <div class="7u -1u 12u(3)">
                    <input type="text" name="search" id="search" placeholder="Rechercher votre point"/>
                </div>
                <div class="1u 12(3)">
                    <select name="type" id="type">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                    </select>
                </div>
                <div class="1u 2u(3) align-center">
                    <input type="submit" value="Search" class="fit"/>
                </div>
            </div>
        </form>

        <div class="row uniform 0%">
            <div class="8u 12u(2)">
                <div id="map" class="map"></div>
            </div>
            <div class="4u 12u(2)">
                <div id="tabs-1">
                    <ul>
                        <li><a href="#tabs-2">Information</a></li>
                        <li><a href="#tabs-3">Iteration</a></li>
                        <li><a href="#tabs-4">Comments</a></li>
                    </ul>
                    <div id="tabs-2" class="">
                        <br/>
                        <h5>Point name:</h5>
                        <p id="slider-info"></p>
                        <h5>Address:</h5>
                        <p id="slider-add"></p>
                        <h5>Infos:</h5>
                        <p id="slider-hour"></p>
                    </div>
                    <div id="tabs-3">
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit,
                            sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris
                            nisi ut aliquip ex ea commodo consequat. </p>
                    </div>
                    <div id="tabs-4">
                        <p>ed ut perspiciatis unde omnis iste natus error sit
                            voluptatem accusantium doloremque laudantium, totam rem aperiam,
                            eaque ipsa quae ab illo inventore veritatis et quasi architecto
                            beatae vitae dicta sunt explicabo.  </p>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit,
                            sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris
                            nisi ut aliquip ex ea commodo consequat. </p>
                    </div>
                    </div>
            </div>

            <div class="12u -1u 10u$ ">
                <div id="owl-slider" class="owl-carousel owl-theme">
                    <div class="item"><h1>1</h1></div>
                    <div class="item"><h1>2</h1></div>
                    <div class="item"><h1>3</h1></div>
                    <div class="item"><h1>4</h1></div>
                    <div class="item"><h1>5</h1></div>
                    <div class="item"><h1>6</h1></div>
                    <div class="item"><h1>7</h1></div>
                    <div class="item"><h1>8</h1></div>
                    <div class="item"><h1>9</h1></div>
                    <div class="item"><h1>10</h1></div>
                    <div class="item"><h1>11</h1></div>
                    <div class="item"><h1>12</h1></div>
                    <div class="item"><h1>13</h1></div>
                    <div class="item"><h1>14</h1></div>
                    <div class="item"><h1>15</h1></div>
                    <div class="item"><h1>16</h1></div>
                </div>
            </div>
        </div>

        <br/>
        <ul class="actions">
            <li><a href="#" class="button special">Sign Up</a></li>
            <li><a href="#" class="button">Learn More</a></li>
        </ul>
    </section>

    {% block cta %}
        {{ parent() }}
    {% endblock %}

    {% block footer %}
        {{ parent() }}
    {% endblock %}

{% endblock %}

{% block javascripts %}

    {{ parent() }}

    <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="http://www.mapquestapi.com/sdk/leaflet/v1.s/mq-map.js?key=Fmjtd%7Cluur2902nu%2C22%3Do5-90805z"></script>
    <script src="http://www.mapquestapi.com/sdk/leaflet/v1.s/mq-routing.js?key=Fmjtd%7Cluur2902nu%2C22%3Do5-90805z"></script>
    <script src="{{ path("sosvelo_point_point_getgeojsonpoints") }}"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('body').attr('class', 'landing');

            $( "#tabs-1" ).tabs();

            var owl = $("#owl-slider");

            owl.owlCarousel({
                loop: true,
                margin: 10,
                responsiveClass: true,
                responsive: {
                    0: {
                        items: 1,
                        nav: true
                    },
                    600: {
                        items: 3,
                        nav: false
                    },
                    1000: {
                        items: 5,
                        nav: true,
                        loop: false
                    }
                }
//                items: 6, //10 items above 1000px browser width
//                itemsDesktop: [1000, 5], //5 items between 1000px and 901px
//                itemsDesktopSmall: [900, 3], // betweem 900px and 601px
//                itemsTablet: [600, 2], //2 items between 600 and 0
//                itemsMobile: false // itemsMobile disabled - inherit from itemsTablet option
            });
        });

    </script>

    {% javascripts '@SOSVeloTemplateBundle/Resources/public/js/owl.carousel.min.js' output='js/owl.carousel.min.js' %}
    <script src="{{ asset_url }}" type="text/javascript"></script>
    {% endjavascripts %}

    <script src="//rawgithub.com/domoritz/leaflet-locatecontrol/gh-pages/dist/L.Control.Locate.min.js"></script>

    <script type="text/javascript">
        var lat_1;
        var lng_1;
        var layer;
        var nearest_lat = lat_1;
        var nearest_lng = lng_1;
        //init_map
        var map = L.map('map', {
            layers: MQ.mapLayer()
        });

        //        L.tileLayer('http://{s}.tile.cloudmade.com/1cc75fcc8e2243d1b2f6aab1e5850be1/998/256/{z}/{x}/{y}.png', {
        //            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
        //            maxZoom: 18
        //        }).addTo(map);
        //end of init_map

        // domoritz/leaflet-locatecontrol => show current position
        L.control.locate().addTo(map);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                lat_1 = position.coords.latitude;
                lng_1 = position.coords.longitude;

                show_points(lat_1, lng_1);
            });

            //geolocation
            map.locate({setView: true, maxZoom: 13});
            function onLocationFound(e) {
                var radius = e.accuracy / 2;

                L.marker(e.latlng).addTo(map)
                        .bindPopup("Vous êtes dans un rayon de " + radius + " mèters de ce point.").openPopup();

                $("#slider-info").text("Vous êtes dans un rayon de " + radius + " mèters de ce point.");

                L.circle(e.latlng, radius).addTo(map);
            }

            map.on('locationfound', onLocationFound);
            //end of geolocation
        } else {
            alert("Géolocalisation n'est pas supportée par votre navigateur. :(");
        }

        //points show_points
        function show_points(lat_1, lng_1) {
            var LeafIcon = L.Icon.extend({
                iconSize: [38, 95],
                iconAnchor: [22, 94],
                popupAnchor: [-3, -76]
            });
            var SOSVeloIcon = new LeafIcon({iconUrl: "{{ asset('bundles/sosvelotemplate/img/sosvelo/sosvelo_icon.png') }}"});

            var RedIcon = L.Icon.extend({
                iconSize: [38, 95],
                iconAnchor: [22, 94],
                popupAnchor: [-3, -76]
            });
            var redIcon = new RedIcon({iconUrl: "{{ asset('bundles/sosvelotemplate/img/sosvelo/marker_icon_red.png') }}"});
            var divIcon = L.divIcon({className: 'divIcon'});

            L.geoJson([points], {
                pointToLayer: function (feature, latLng) {
                    var lat_2 = latLng.lat;
                    var lng_2 = latLng.lng;
                    if (nearest_lat == undefined) {
                        nearest_lat = latLng.lat;
                        nearest_lng = latLng.lng;
                    }
                    if (latLng.distanceTo({
                                lat: lat_1,
                                lng: lng_1
                            }) < L.latLng(nearest_lat, nearest_lng).distanceTo({lat: lat_1, lng: lng_1})) {
                        nearest_lat = lat_2;
                        nearest_lng = lng_2;
                    }
                    {% if is_granted('ROLE_ADMIN') %}
                    if (feature.properties.activated) {
                        return L.marker(latLng, {
                            icon: SOSVeloIcon
                        }).bindPopup("SOSVélo : " + feature.properties.name + "<br> Adresse : " + feature.properties.adress + "<br> Infos : " + feature.properties.description + "<br><br><a href='#' onClick='routeToPoint(lat_1, lng_1, " + lat_2 + ", " + lng_2 + ")'>Aller à ce point</a><span class='space_80px'/><a href='#' onClick='deletePoint(" + feature.properties.id + ")'>Supprimer ce point.</a>");
                    }
                    else {
                        return L.marker(latLng, {
                            icon: redIcon
                        }).bindPopup("SOSVélo : " + feature.properties.name + "<br> Adresse : " + feature.properties.adress + "<br> Infos : " + feature.properties.description + "<br><br><a href='#' onClick='activatePoint(" + feature.properties.id + ")'>Activer ce point.</a><span class='space_80px'/><a href='#' onClick='deletePoint(" + feature.properties.id + ")'>Supprimer ce point.</a>");
                    }
                    {% else %}
                    if (feature.properties.activated) {
//                        document.getElementById("slider-info").innerHTML = "SOSVélo : " + feature.properties.name + "<br> Adresse : " + feature.properties.adress + "<br> Infos : " + feature.properties.description + "<br><br><a href='#' onClick='routeToPoint(lat_1, lng_1, " + lat_2 + ", " + lng_2 + ")'>Aller à ce point</a>";
                        return L.marker(latLng, {
                            icon: SOSVeloIcon
                        }).bindPopup("SOSVélo : " + feature.properties.name + "<br> Adresse : " + feature.properties.adress + "<br> Infos : " + feature.properties.description + "<br><br><a href='#' onClick='routeToPoint(lat_1, lng_1, " + lat_2 + ", " + lng_2 + ")'>Aller à ce point</a>");
                    }
                    else {
                        return L.marker(latLng, {icon: divIcon});
                    }
                    {% endif %}
                }
            }).addTo(map);
        }
        //end of show_points

        //route
        function route(lat_1, lng_1, lat_2, lng_2) {
            if (layer != null)
                map.removeLayer(layer);

            dir = MQ.routing.directions();
            dir = MQ.routing.directions()
                    .on('success', function (data) {
                        var legs = data.route.legs,
                                html = '',
                                maneuvers,
                                i;

                        if (legs && legs.length) {
                            maneuvers = legs[0].maneuvers;

                            for (i = 0; i < maneuvers.length; i++) {
                                html += (i + 1) + '. ';
                                html += maneuvers[i].narrative + '<br />';
                            }

                            L.DomUtil.get('route-narrative').innerHTML = html;
                        }
                    });
            dir.route({
                locations: [
                    {latLng: {lat: lat_1, lng: lng_1}},
                    {latLng: {lat: lat_2, lng: lng_2}}
                ],
                options: {routeType: 'bicycle', locale: "fr_FR"}
            });
            layer = MQ.routing.routeLayer({
                directions: dir,
                fitBounds: true,
                locale: "fr_FR"
            });
            map.addLayer(layer);
        }
        //end of route
        //nearest
        function nearest() {
            route(lat_1, lng_1, nearest_lat, nearest_lng);
        }
        //end nearest
        //routeToPoint
        function routeToPoint(lat_1, lng_1, lat_2, lng_2) {
            route(lat_1, lng_1, lat_2, lng_2);
        }
        //end routeToPoint
        //deletePoint
        function deletePoint(id) {
            $.ajax({
                url: 'points/' + id,
                type: 'DELETE',
                success: function () {
                    alert("Point supprimé avec succès .");
                    window.location.href = "home";
                }
            });
        }
        //end deletePoint
        //activatePoint
        function activatePoint(id) {
            $.ajax({
                url: 'points/activate/' + id,
                type: 'POST',
                success: function () {
                    alert("Point activé avec succès .");
                    window.location.href = "home";
                }
            });
        }
        //end activatePoint
        var popup = L.popup();

        map.on("popupopen", function (e) {
            var marker = e.popup._source;
            if (typeof marker['feature'] !== 'undefined') {
                console.log(marker);
                $("#slider-info").text(marker['feature']['properties']['name']);
                $("#slider-add").text(marker['feature']['properties']['adress']);
                $("#slider-hour").text(marker['feature']['properties']['description']);
            }
        });

        function onMapClick(e) {
            popup
                    .setLatLng(e.latlng)
                    .setContent("You clicked the map at " + e.latlng.toString())
                    .openOn(map);
        }

        map.on('click', onMapClick);

        // responsive design for map, resize the map according to the current window's size
        $(window).on("resize", function () {
            $("#map").height($(window).height() / 2.2).width($(this).parent().width());
//            map.invalidateSize();
        }).trigger("resize");
    </script>

{% endblock %}
